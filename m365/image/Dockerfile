FROM mcr.microsoft.com/windows/servercore:ltsc2022

ARG SCUBAGEAR_VERSION=1.5.0
# Get static URL for current version: curl -s -D- https://aka.ms/downloadazcopy-v10-windows | grep ^Location
# https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-v10?tabs=dnf#obtain-a-static-download-link
ARG AZCOPY_URL=https://azcopyvnext-awgzd8g7aagqhzhe.b02.azurefd.net/releases/release-10.29.0-20250428/azcopy_windows_amd64_10.29.0.zip 

LABEL scubagear_version=${SCUBAGEAR_VERSION}

WORKDIR /app

# download azcopy exe to workdir
RUN powershell Invoke-WebRequest -Uri %AZCOPY_URL% -OutFile AzCopy.zip -UseBasicParsing
RUN powershell Expand-Archive .\AzCopy.zip ./AzCopy -Force
RUN powershell $item = Get-ChildItem .\AzCopy\*\azcopy.exe; Move-Item -Path $item -Destination .
RUN powershell Remove-Item AzCopy.zip; Remove-Item -r .\AzCopy

# Needed for setup module installs
RUN powershell Install-PackageProvider -Name NuGet -Force
RUN powershell Install-Module -Name ScubaGear -RequiredVersion %SCUBAGEAR_VERSION% -Force
RUN powershell Initialize-SCuBA -Scope AllUsers
COPY run_container.ps1 .

# Move opa exe to expected path for ContainerUser and grant execute permissions. Then switch to that user
RUN powershell New-Item -Path C:\Users\ContainerUser\.scubagear\Tools -ItemType Directory
RUN powershell Move-Item C:\Users\ContainerAdministrator\.scubagear\Tools\* C:\Users\ContainerUser\.scubagear\Tools
RUN icacls C:\Users\ContainerUser\.scubagear\Tools\* /grant "User Manager\ContainerUser":RX
USER ContainerUser

CMD [ "powershell", ".\\run_container.ps1" ]
